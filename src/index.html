<!DOCTYPE html>
<html>
<head>
    <title>GabChat</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <!-- We are using the modular SDK, so no -compat scripts are needed here. -->
    <!-- The import statements in the script block will handle loading the SDK parts. -->
</head>
<body>
    <div id="auth-container">
        <button id="google-signin-button">Sign in with Google</button>
    </div>

    <div id="user-info" style="display: none;">
        <p>Welcome, <span id="user-name"></span>!</p>
        <button id="logout-button">Logout</button>
    </div>

    <div id="chat-container" style="display: none;">
        <h2>Chat</h2>
        <div id="chat-history">
            <!-- Chat messages will appear here -->
        </div>
        <input type="text" id="message-input" placeholder="Type your message...">
        <button id="send-button">Send</button>
    </div>

    <div id="api-key-container" style="display: none;">
        <h3>Enter your Gemini API Key</h3>
        <input type="text" id="api-key-input" placeholder="Gemini API Key">
        <button id="save-api-key-button">Save Key</button>
    </div>

    <script type="module">
        // Import functions from the Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBRS6_fValVt0ZPtcLykcfcuZe2UYOEGHo",
          authDomain: "gabchat-e1851.firebaseapp.com",
          projectId: "gabchat-e1851",
          storageBucket: "gabchat-e1851.firebasestorage.app",
          messagingSenderId: "28310426932",
          appId: "1:28310426932:web:6aeec20e5dfdf84c18c161"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Google Sign-In
        const googleSignInButton = document.getElementById('google-signin-button');
        googleSignInButton.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then((result) => {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    // const credential = GoogleAuthProvider.credentialFromResult(result);
                    // const token = credential.accessToken;
                    // The signed-in user info.
                    const user = result.user;
                    console.log("User signed in: ", user);
                    
                    // Get the ID token
                    user.getIdToken().then((idToken) => {
                        // Send token to backend for verification
                        fetch('/verify-token', { 
                            method: 'POST', 
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({token: idToken})
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log("Token verification response: ", data);
                            if(data.status === "success"){
                                // Update UI handled by onAuthStateChanged
                            } else {
                                console.error("Token verification failed: ", data.error);
                                // Handle failed verification on client side if needed
                            }
                        })
                        .catch(error => {
                            console.error("Error sending token to backend: ", error);
                        });
                    });
                })
                .catch((error) => {
                    console.error("Google Sign-In Error: ", error);
                    // const errorCode = error.code;
                    // const errorMessage = error.message;
                    // The email of the user's account used.
                    // const email = error.email;
                    // The AuthCredential type that was used.
                    // const credential = GoogleAuthProvider.credentialFromError(error);
                });
        });

        // Logout
        const logoutButton = document.getElementById('logout-button');
        logoutButton.addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log("User signed out.");
                // Update UI handled by onAuthStateChanged
            }).catch((error) => {
                console.error("Logout Error: ", error);
            });
        });

        // Listen for authentication state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                console.log("onAuthStateChanged: User is signed in", user);
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('user-info').style.display = 'block';
                document.getElementById('user-name').textContent = user.displayName;
                document.getElementById('chat-container').style.display = 'block';
                document.getElementById('api-key-container').style.display = 'block';
            } else {
                // User is signed out
                console.log("onAuthStateChanged: User is signed out");
                document.getElementById('auth-container').style.display = 'block';
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('chat-container').style.display = 'none';
                document.getElementById('api-key-container').style.display = 'none';
            }
        });

        // Placeholder for API key saving and chat message sending
        // JavaScript for sign-in, chat, and API key management will go here
    </script>
</body>
</html>